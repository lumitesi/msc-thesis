%!TEX root = ../template.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% chapter4.tex
%% NOVA thesis document file
%%
%% Chapter with lots of dummy text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Implementation of \textit{iCBD-Replication} and Cache Server}
\label{cha:replication}

This chapter addresses the implementation of the central topics of this thesis, divided into two major fields.
The first section talks about the creation of a middleware system that provides replication features in an integrated way to the iCBD platform. A detailed description of the concept and architectural model, as well as the implementation decisions, can be found in this section.
Then, we show how the performance of the platform clients can be heightened by setting up a client-side caching system that stores images adjacent to the consumers. Concluding in exploring the challenges of recreating the complete platform in a new environment and implementing a real-world scenario at Nova University Computer Science department laboratories.


%%-------------------------------------------------------------------
%%	4 - Implementation of a Replication Module
%%-------------------------------------------------------------------
\section{Implementation of a Replication Module}
\label{sec:replication_impl}

One of the central objectives of iCBD is to provide a platform that can be both cloud-centric, with the administration and a portion of the storage burden gathered in a public cloud, or fully hosted on client premises. Either way, it becomes evident that data locality is an important subject, which means that there is the need to study how this data will flow between the multiple components of the iCBD platform.
As can be imagined this is a data-intensive platform, bosting multiple storage devices in many networks and an array of consumers demanding that data at any given time.
All these factors allied to the platform architecture result in the need to create a new component, whose chief mission is to ensure that the data is correctly replicated in the appropriate places, maintaining the consistency of the various versions of VM images stored.

%%-------------------------------------------------------------------
%%	4. - Requirements of the Module
%%-------------------------------------------------------------------
\subsection{Requirements of the Module}
\label{sub:requirements_icbdrep}


%%-------------------------------------------------------------------
%%	4. - Preliminary tests on the BTRFS Incremental Backup features
%%-------------------------------------------------------------------
\subsubsection{Preliminary tests on the BTRFS Incremental Backup features}
\label{subsub:pre_test_btrfs}

%https://btrfs.wiki.kernel.org/index.php/Incremental_Backup
%https://www.samba.org/ftp/rsync/rsync.html

The first step is to try to understand the most efficient way to transfer this peculiar kind of data. Given the fact that we are working with a file system with snapshots capabilities, we want to take advantage of this functionality and minimise the amount of data roaming the network. In this sense, we next present some preliminary tests in multiple ways of transferring snapshots between BTRFS file systems both in the same machine and in different ones.
The results obtained here conjugated with the defined requirements are essential for defining the architecture of the replication module steering the implementation at its best path.

Before the start of any implementation, there was the need to validate the capabilities of the BTRFS file system regarding sending snapshots across different systems.
As one of the requirements was the efficiency of the transference of data. So a small comparison was in order. 


%%-------------------------------------------------------------------
%%	4. - Image Repository
%%-------------------------------------------------------------------
\subsection{Image Repository}
\label{sub:rep_image_repo}

\subsubsection{iCBD Snapshot Structure}
\label{subsub:icbd_snapshot}

In the replication module we treat a snapshot not only as raw data, but a collection of data and metadata that is essencial to unequivocally distinguish the multiple images present in the system. 


%%-------------------------------------------------------------------
%%	4. - Communications between image repositories
%%-------------------------------------------------------------------
\subsection{Communications between image repositories}
\label{sub:rep_rpcs}


%%-------------------------------------------------------------------
%%	4. - Pyro4 Library
%%-------------------------------------------------------------------
\subsubsection{Pyro4 Library}
\label{subsub:rep_pyro4}

%https://pythonhosted.org/Pyro4/


%%-------------------------------------------------------------------
%%	4. - Master Node
%%-------------------------------------------------------------------
\subsection{Master Node}
\label{sub:rep_master_node}


%%-------------------------------------------------------------------
%%	4. - Replica Node
%%-------------------------------------------------------------------
\subsection{Replica Node}
\label{sub:rep_replica_node}






%%-------------------------------------------------------------------
%%	4. - Building a iCBD Cache Server
%%-------------------------------------------------------------------
\section{Building a iCBD Cache Server}
\label{sec:cache_server}

Found a Centos 7 kernel bug.
%https://bugs.centos.org/view.php?id=14228
%https://bugzilla.redhat.com/show_bug.cgi


%%-------------------------------------------------------------------
%%	4. - Services
%%-------------------------------------------------------------------
\subsection{Services}
\label{sub:cache_services}


%%-------------------------------------------------------------------
%%	4. - Networking
%%-------------------------------------------------------------------
\subsection{Networking}
\label{sub:cache_networking}

%%-------------------------------------------------------------------
%%	4. - Extra Efforts
%%-------------------------------------------------------------------
\subsection{Extra Efforts}
\label{sub:extra_efforts}


GitLab

Since the work maily goes around replication and infrastructure problems, makes all sence to think in how the base code is handled. Thinking on this subject and avaluating the code backup system in place (talk what is the system in place), a svc system is ideial to what we what to acomplish.
So a GitLab on premises system was deployed and configured. Also configured multiple repositorys that will back each module of the iCBD platform.
There are two main objectives with this premisse.
First, provide an safe envoiroment for backing up all the base code of the modules. As well as provide versioning control of the that same code.
Second, facilitate a way to replicate the base code of the multiple modules though the various infrastructures running the icbd platform in a clean and transparent way.
Talk a bit of git vantages. (Replication possibilities, backing with the cloud..)
How is implemented. (Vm in reditus infra..)



